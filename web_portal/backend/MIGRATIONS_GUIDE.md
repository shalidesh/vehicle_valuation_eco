# Database Migrations Guide

## Overview

This project uses **Alembic** as the single source of truth for database schema management. All schema changes (tables, indexes, constraints) must be done through Alembic migrations.

## Architecture

### Migration Flow

```
┌─────────────────┐
│   Postgres DB   │
│   (Healthy)     │
└────────┬────────┘
         │
         ▼
┌─────────────────────────┐
│   db_migrations         │
│   (Runs migrations)     │
│   - Waits for DB        │
│   - Runs alembic upgrade│
│   - Exits on completion │
└────────┬────────────────┘
         │ (Success)
         ▼
┌─────────────────────────┐
│   web_dashboard_backend │
│   (Starts application)  │
│   - No table creation   │
│   - Pure business logic │
└─────────────────────────┘
```

### Key Components

1. **Alembic Configuration** (`alembic.ini`)
   - Main configuration file for Alembic
   - Database URL is read from environment variable

2. **Migration Environment** (`alembic/env.py`)
   - Configures Alembic to use SQLAlchemy models
   - Imports all models for autogenerate support

3. **Migration Scripts** (`alembic/versions/`)
   - Contains all migration files
   - `001_initial_schema.py` - Initial database schema

4. **Migration Runner** (`run_migrations.py`)
   - Standalone script to run migrations
   - Waits for database to be ready
   - Executes `alembic upgrade head`

5. **Migration Container** (`Dockerfile.migrations`)
   - Dedicated container for running migrations
   - Runs before application containers

## Usage

### Running Migrations in Docker

Migrations run automatically when you start the services:

```bash
docker-compose up
```

The `db_migrations` service will:
1. Wait for PostgreSQL to be healthy
2. Run all pending migrations
3. Exit successfully
4. Allow backend service to start

### Creating New Migrations

When you modify SQLAlchemy models, create a new migration:

```bash
# Navigate to backend directory
cd web_portal/backend

# Generate migration (with autogenerate)
alembic revision --autogenerate -m "description of changes"

# Or create empty migration
alembic revision -m "description of changes"
```

### Manual Migration Commands

```bash
# View migration history
alembic history

# View current version
alembic current

# Upgrade to latest
alembic upgrade head

# Upgrade to specific version
alembic upgrade <revision>

# Downgrade one version
alembic downgrade -1

# Downgrade to specific version
alembic downgrade <revision>

# View SQL without executing
alembic upgrade head --sql
```

## Important Rules

### ✅ DO:
- Use Alembic for ALL schema changes
- Create migrations for:
  - New tables
  - Column additions/modifications
  - Index changes
  - Constraint changes
  - Data type changes
- Test migrations locally before deploying
- Review autogenerated migrations carefully

### ❌ DON'T:
- Don't use `Base.metadata.create_all()` in application code
- Don't use `init.sql` for schema management
- Don't modify database schema directly
- Don't skip migration testing
- Don't delete migration files

## Migration Best Practices

1. **Descriptive Names**
   ```bash
   alembic revision -m "add_user_profile_table"
   alembic revision -m "add_email_index_to_users"
   ```

2. **Review Autogenerated Migrations**
   - Alembic might not detect all changes
   - Always review generated migration files
   - Add custom logic if needed

3. **Test Migrations**
   ```bash
   # Test upgrade
   alembic upgrade head

   # Test downgrade
   alembic downgrade -1

   # Test upgrade again
   alembic upgrade head
   ```

4. **Data Migrations**
   When you need to migrate data along with schema:
   ```python
   def upgrade():
       # Schema change
       op.add_column('users', sa.Column('status', sa.String(20)))

       # Data migration
       connection = op.get_bind()
       connection.execute(
           text("UPDATE users SET status = 'active' WHERE status IS NULL")
       )
   ```

## Troubleshooting

### Migration Container Keeps Restarting

Check migration logs:
```bash
docker-compose logs db_migrations
```

Common issues:
- Database not ready (check postgres health)
- Migration syntax errors
- Database connection issues

### Migrations Not Running

1. Verify migration service in docker-compose.yml
2. Check database connection string
3. Ensure backend service depends on migrations:
   ```yaml
   depends_on:
     db_migrations:
       condition: service_completed_successfully
   ```

### Conflict with Existing Tables

If tables already exist:

**Option 1: Stamp database** (for existing deployments)
```bash
# Mark database as at specific revision without running migrations
alembic stamp head
```

**Option 2: Fresh start** (for development)
```bash
# Drop all tables and re-run migrations
docker-compose down -v
docker-compose up
```

### Migration Failed Midway

```bash
# Check current version
alembic current

# If stuck, manually fix and mark as complete
alembic stamp <revision>

# Or rollback
alembic downgrade <previous_revision>
```

## Environment Variables

The migration system uses these environment variables:

```bash
DATABASE_URL=postgresql+psycopg2://user:password@host:port/database
```

Set in docker-compose.yml:
```yaml
environment:
  - DATABASE_URL=postgresql+psycopg2://airflow:airflow@postgres:5432/airflow
```

## File Structure

```
web_portal/backend/
├── alembic/                    # Alembic directory
│   ├── versions/              # Migration scripts
│   │   └── 001_initial_schema.py
│   ├── env.py                 # Alembic environment
│   ├── script.py.mako         # Template for new migrations
│   └── README                 # Alembic readme
├── alembic.ini                # Alembic configuration
├── run_migrations.py          # Migration runner script
├── Dockerfile.migrations      # Migration container Dockerfile
└── app/
    └── models/               # SQLAlchemy models (source of truth)
```

## Example Workflow

### Adding a New Column

1. **Update Model** (`app/models/user.py`)
   ```python
   class User(Base):
       __tablename__ = "users"
       # ... existing columns ...
       phone = Column(String(20), nullable=True)  # New column
   ```

2. **Generate Migration**
   ```bash
   alembic revision --autogenerate -m "add_phone_to_users"
   ```

3. **Review Migration** (`alembic/versions/xxx_add_phone_to_users.py`)
   ```python
   def upgrade():
       op.add_column('users', sa.Column('phone', sa.String(20), nullable=True))

   def downgrade():
       op.drop_column('users', 'phone')
   ```

4. **Test Locally**
   ```bash
   alembic upgrade head
   alembic downgrade -1
   alembic upgrade head
   ```

5. **Deploy**
   ```bash
   docker-compose build db_migrations
   docker-compose up
   ```

## Migration Service Configuration

In `docker-compose.yml`:

```yaml
db_migrations:
  build:
    context: ./web_portal/backend
    dockerfile: Dockerfile.migrations
  container_name: db_migrations
  environment:
    - DATABASE_URL=postgresql+psycopg2://airflow:airflow@postgres:5432/airflow
  networks:
    - live_net
    - uat_net
  depends_on:
    postgres:
      condition: service_healthy
  restart: on-failure
```

## Monitoring Migrations

View migration status:
```bash
# Check if migrations ran
docker-compose logs db_migrations

# Check current database version
docker-compose exec web_dashboard_backend_live alembic current

# View migration history
docker-compose exec web_dashboard_backend_live alembic history
```

## Additional Resources

- [Alembic Documentation](https://alembic.sqlalchemy.org/)
- [SQLAlchemy Documentation](https://www.sqlalchemy.org/)
- [Docker Compose Documentation](https://docs.docker.com/compose/)
